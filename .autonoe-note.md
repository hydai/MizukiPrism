# Session Handoff Notes - 2026-02-20 (META-004 Complete)

## This Session

Implemented META-004: CLI metadata clear command.

### What Was Accomplished

Added `mizukilens metadata clear` subcommand to `tools/mizukilens/src/mizukilens/cli.py`.

**Command signature:**
```
mizukilens metadata clear SONG_ID [--all] [--force]
```

**Implementation in `cli.py` (`metadata_clear_cmd`):**
- Single song clear (`SONG_ID` without `--all`):
  - Checks if there's anything to clear in song-metadata.json or song-lyrics.json first
  - Looks up song title/artist from songs.json (warns if not found, proceeds anyway)
  - Shows confirmation prompt using `click.confirm()` unless `--force` is given
  - Removes matching entries from both song-metadata.json and song-lyrics.json
  - Does NOT touch artist-info.json (per spec §3.1.3)
  - Prints "Cleared metadata for 'Song Title'"
- Clear all (`--all`):
  - Checks if there are any entries first; exits cleanly if already empty
  - Shows confirmation prompt unless `--force`
  - Writes `[]` to both song-metadata.json and song-lyrics.json
  - Does NOT touch artist-info.json
  - Prints "Cleared all song metadata (N entries) and lyrics (M entries)"
- Argument validation:
  - Errors if neither SONG_ID nor --all is provided
  - Errors if both SONG_ID and --all are provided

**Tests added in `test_metadata.py` (`TestCLIMetadataClear`, 20 tests):**
- Clear specific song removes from song-metadata.json
- Clear specific song removes from song-lyrics.json
- ArtistInfo NOT removed when clearing a song
- Clear with --force skips confirmation
- Output contains song title after clearing
- Clear non-existent song ID: clean exit with message
- Clear non-existent song ID does not modify files
- Song ID not in songs.json: warns but still clears
- Without --force: 'n' cancels, 'y' confirms
- --all --force empties metadata file
- --all --force empties lyrics file
- --all preserves artist-info.json
- --all output shows counts
- --all on empty files exits cleanly
- --all without --force: 'n' cancels
- After clear, metadata status shows song as pending
- After clear, metadata fetch can re-fetch the song
- No args: exits with error
- SONG_ID + --all together: exits with error

### Acceptance Criteria Verification

- [x] AC1: At least one song has metadata (fixture pre-populates both songs)
- [x] AC2/AC3: `metadata clear SONG_ID` without --force shows prompt, prompts confirmed
      → test_clear_without_force_confirm_yes_clears
- [x] AC4: Song entries removed from both song-metadata.json and song-lyrics.json
      → test_clear_specific_song_removes_from_metadata + test_clear_specific_song_removes_from_lyrics
- [x] AC5: ArtistInfo NOT removed
      → test_clear_does_not_remove_artist_info
- [x] AC6: `metadata status --filter pending` shows cleared song as pending
      → test_after_clear_song_appears_as_pending_in_status
- [x] AC7: `metadata fetch --song <id>` can re-fetch after clear
      → test_after_clear_song_can_be_refetched
- [x] AC8: `metadata clear --all --force` empties both files
      → test_clear_all_empties_metadata_file + test_clear_all_empties_lyrics_file
- [x] AC9: artist-info.json preserved after --all clear
      → test_clear_all_preserves_artist_info

### Test Results

- All 740 tests pass (146 original metadata tests + 20 new clear tests + all other tests)
- lineguard: all changed files pass

## Current Project Status

- MizukiPrism frontend: stable (50+ E2E tests passing)
- MizukiLens CLI metadata subcommands: META-001 (fetch), META-002 (status), META-003 (override), META-004 (clear) complete
- META-005 (album art display), META-006 (synced lyrics) complete

## All Tasks

| Task | Status |
|------|--------|
| META-001 | done |
| META-002 | done |
| META-003 | done |
| META-004 | done (this session) |
| META-005 | done |
| META-006 | done |
