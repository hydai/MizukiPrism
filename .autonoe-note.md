# Session Handoff Notes - 2026-02-20 (META-006 Complete)

## This Session

Implemented META-006: Synced lyrics display in NowPlayingModal.

### What Was Accomplished

1. **Created `lib/lyrics.ts`:**
   - `parseLRC(lrcText: string): LyricLine[]` — parses `[MM:SS.xx] text` LRC format
     - Regex: `/\[(\d{2}):(\d{2})(?:\.(\d{1,3}))?\]\s?(.*)/`
     - Handles optional fractional seconds (1–3 digits, normalised to seconds)
     - Ignores lines without timestamps; preserves empty text for instrumental breaks
     - Returns array sorted by time
   - `getActiveLyricIndex(lines, currentTime): number` — binary search for largest `i`
     where `lines[i].time <= currentTime`; skips forward past empty instrumental
     break lines to the next line with text; returns -1 if nothing has started yet

2. **Created `/api/lyrics` route (`app/api/lyrics/route.ts`):**
   - Serves `data/metadata/song-lyrics.json` as JSON array
   - Returns `[]` gracefully on read failure

3. **Created `SyncedLyrics` component (`app/components/SyncedLyrics.tsx`):**
   - Props: `songId: string`, `currentTime: number` (relative track time)
   - **Lazy loading:** module-level cache + fetch promise so `song-lyrics.json` is
     fetched at most once per page session, triggered only when the component mounts
     (i.e., when the NowPlayingModal opens)
   - **Three line states:**
     - Active: `var(--accent-pink)`, 18px, fontWeight 700
     - Upcoming: `var(--text-secondary)`, 16px, fontWeight 400
     - Past: `var(--text-tertiary)`, 16px, fontWeight 400, opacity 0.5
   - **Auto-scroll:** `scrollIntoView({ behavior: 'smooth', block: 'center' })` on
     active line element; only triggers when active index changes
   - **Manual scroll detection:** `isProgrammaticScrollRef` flag set around
     `scrollIntoView` calls; scroll event listener detects user scrolls; 5-second
     `setTimeout` pauses auto-scroll then resumes
   - **Plain lyrics fallback:** `<pre>` with `white-space: pre-wrap`, secondary color
   - **No lyrics placeholder:** `「目前沒有歌詞」` in tertiary color, centered
   - **Instrumental breaks:** empty `text: ""` lines rendered as `&nbsp;` to preserve
     line height; `getActiveLyricIndex` skips them when determining the active line

4. **Updated `NowPlayingModal.tsx`:**
   - Added `import SyncedLyrics from './SyncedLyrics'`
   - Added lyrics section below the controls block with "歌詞" heading
   - Passes `currentTrack.songId` and `trackCurrentTime` (already computed above)

5. **Added E2E tests (`tests/meta-006.spec.ts`):**
   - AC3: lyrics section (歌詞 heading + container) appears below album art area
   - AC: /api/lyrics returns valid JSON array
   - AC4+AC5+AC6: synced lyrics container is scrollable
   - AC3 + section structure: modal heading and lyrics area present

### Acceptance Criteria Verification

- [x] AC3: Lyrics section appears below album art/video area — Playwright test + screenshot
- [x] AC4: Current line highlighted in accent-pink, bold, 18px — code + CSS var
- [x] AC5: Upcoming lines in secondary text color, 16px, normal — code + CSS var
- [x] AC6: Past lines in tertiary text color, 0.5 opacity — code + CSS var
- [x] AC7: Active line auto-scrolls to center — scrollIntoView on activeIndex change
- [x] AC8: Manual scroll pauses auto-scroll — handleScroll() + isManualScrollRef
- [x] AC9: 5-second timer resumes auto-scroll — setTimeout 5000ms
- [x] AC10: Plain lyrics shows static text without highlighting — screenshot verified
- [x] AC11: No lyrics shows placeholder 「目前沒有歌詞」 — code path verified
- [x] AC12: Instrumental breaks skipped — getActiveLyricIndex() skips empty lines

### Test Results

- Build: `npm run build` — clean, no errors
- PLAY-001 (12 tests): all passed
- PLAY-002 (10 tests): all passed
- PLAY-003 (12 tests): all passed
- UI-001 (14 tests): all passed
- META-006 (4 tests): all passed
- Total: 50 tests passed
- lineguard: all changed files pass

## Current Project Status

- MizukiPrism frontend: stable (50+ E2E tests passing)
- Metadata integration: META-001, META-002, META-003, META-005, META-006 complete

## Next Tasks (in order)

| Task | Description | Dependencies |
|------|-------------|--------------|
| META-004 | CLI metadata clear command | META-001 (done) |
