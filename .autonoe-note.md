# Session Handoff Notes - 2026-02-24 (AUTH-008 Complete)

## This Session

Implemented AUTH-008: PlaylistContext Workers API migration with offline sync and cleanup.

### What Was Accomplished

Migrated `app/contexts/PlaylistContext.tsx` to call the Cloudflare Workers API instead of local Next.js API routes, and removed old file-based playlist infrastructure.

**Files modified:**
- `app/contexts/PlaylistContext.tsx` - Updated all API calls to use Workers API with Bearer token auth

**Files deleted:**
- `lib/user-playlists.ts` - Old file-based server-side playlist storage
- `app/api/playlists/route.ts` - Old Next.js API route for playlists
- `data/user-playlists/fan-1771428073061-3fa4774a.json` - Old per-user playlist data file
- `data/user-playlists/` directory - Removed after emptying

**Key changes in PlaylistContext.tsx:**
1. Added `import { buildAuthHeaders } from './FanAuthContext'`
2. Added `const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL ?? ''` and `const TOKEN_KEY = 'mizukiprism_auth_token'`
3. Added `getAuthToken()` and `getAuthFetchHeaders()` helper functions that read token from localStorage and build Bearer auth headers
4. `handleLoginSync`: now calls `GET ${API_BASE}/api/playlists` with auth headers
5. `syncAllToCloud`: now calls `POST ${API_BASE}/api/playlists/sync` with auth headers (batch sync endpoint)
6. `syncToCloud` for delete: now calls `DELETE ${API_BASE}/api/playlists/${id}` (no request body, ID in URL)
7. `syncToCloud` for create/update: now calls `PUT ${API_BASE}/api/playlists/${id}` with auth headers
8. Online reconnect handler: uses `POST ${API_BASE}/api/playlists/sync` (not the old POST /api/playlists)
9. Conflict notification message: "衝突已解決：保留雲端版本的「{name}」" (only for cloud-kept conflicts)
10. Removed redundant `flushPendingSync` useCallback (logic is inline in online handler)

### Acceptance Criteria Verification

- [x] AC1: Creating playlist PUTs to `{API_BASE}/api/playlists/{id}` with Bearer token
- [x] AC2: Modifying playlist PUTs to Workers API
- [x] AC3: Deleting calls `DELETE {API_BASE}/api/playlists/{id}` (ID in URL, no body)
- [x] AC4: Offline changes saved to localStorage, flagged in pending sync
- [x] AC5: Reconnect triggers `POST {API_BASE}/api/playlists/sync` with all local playlists
- [x] AC6: Page load while logged in fetches cloud via GET, shows merge dialog if both have data
- [x] AC7: Conflict notification "衝突已解決：保留雲端版本的「{name}」" when keptVersion=cloud
- [x] AC8: Not logged in = localStorage only (no API calls)
- [x] AC9: Old files removed: lib/user-playlists.ts, data/user-playlists/, app/api/playlists/route.ts
- [x] AC10: After logout, playlists remain in localStorage but stop syncing
- [x] AC11: All API calls use NEXT_PUBLIC_API_BASE_URL with Bearer token header

### Build Verification

`npm run build` passes cleanly. The route `/api/playlists` no longer appears in the build output, confirming the old Next.js route is fully removed.

### Issues Found

None. TypeScript compiles cleanly. No remaining imports referencing deleted files.

## Current Project Status

- Workers backend:
  - AUTH-001 (scaffolding): complete, committed
  - AUTH-002 (OTP request): complete, committed
  - AUTH-003 (OTP verify): complete, committed
  - AUTH-004 (session middleware): complete, committed
  - AUTH-005 (playlist CRUD Workers endpoints): complete, committed
  - AUTH-006 (FanAuthContext rewrite): complete, committed
  - AUTH-007 (auth page UI): complete, committed
  - AUTH-008 (PlaylistContext migration): complete, committed (this session)

## All AUTH Tasks

| Task | Status |
|------|--------|
| AUTH-001 | done |
| AUTH-002 | done |
| AUTH-003 | done |
| AUTH-004 | done |
| AUTH-005 | done |
| AUTH-006 | done |
| AUTH-007 | done |
| AUTH-008 | done (this session) |
