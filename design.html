import React, { useState, useMemo } from 'react';
import { Search, Play, ExternalLink, X, Mic2, Disc, Filter, Youtube, Twitter, Sparkles, Music, Home, ListMusic, Clock, Calendar, BarChart2, Heart } from 'lucide-react';

// ==========================================
// 1. ç›´æ’­ä¸»è¨­å®šæª” (Configuration)
// ==========================================
const STREAMER_INFO = {
  name: "Mizuki",
  subTitle: "Official Song Archive",
  description: "æ¸…æ¥šç³»æ­Œå‹¢ V-Streamerï¼Œå¸¶çµ¦ä½ å¦‚å¤¢ä¼¼å¹»çš„æ­Œè²ã€‚",
  avatarUrl: "https://api.dicebear.com/7.x/micah/svg?seed=Mizuki&backgroundColor=b6e3f4",
  socialLinks: {
    youtube: "https://youtube.com",
    twitter: "https://twitter.com"
  }
};

// ==========================================
// 2. æ­Œæ›²è³‡æ–™åº« (Database)
// ==========================================
const SONG_DATABASE = [
  {
    id: 'song-1',
    title: 'First Love',
    originalArtist: 'å®‡å¤šç”°å…‰',
    tags: ['æŠ’æƒ…', 'J-POP', 'ç¶“å…¸'],
    performances: [
      { id: 'p1-1', date: '2023-10-15', streamTitle: 'ç§‹æ—¥æ­Œå› ğŸ‚', videoId: '_Q5-4yMi-xg', timestamp: 120, note: 'æ¸…å”±ç‰ˆ' },
      { id: 'p1-2', date: '2024-01-20', streamTitle: 'æ…¶ç¥ 50 è¬è¨‚é–±ï¼', videoId: '0pZ-W81c-dw', timestamp: 3450, note: 'å‰ä»–ä¼´å¥' },
    ]
  },
  {
    id: 'song-2',
    title: 'Idol (ã‚¢ã‚¤ãƒ‰ãƒ«)',
    originalArtist: 'YOASOBI',
    tags: ['å‹•æ¼«æ­Œ', 'å¿«ç¯€å¥', 'é«˜éŸ³'],
    performances: [
      { id: 'p2-1', date: '2023-05-01', streamTitle: 'äº”æœˆç—…é€€æ•£ï¼é«˜æ­ŒçŒ›é€²', videoId: 'ZRtdQ81jPUQ', timestamp: 500, note: '' },
      { id: 'p2-2', date: '2023-12-31', streamTitle: 'è·¨å¹´å€’æ•¸æ­Œå›', videoId: 'mZAiTdZ9r9E', timestamp: 7200, note: 'è·¨å¹´ç‰¹åˆ¥ç‰ˆ' },
      { id: 'p2-3', date: '2024-02-14', streamTitle: 'æƒ…äººç¯€ç‰¹è¼¯', videoId: 'PgBvV9ofjMA', timestamp: 100, note: '' },
    ]
  },
  {
    id: 'song-3',
    title: 'Betelgeuse (ãƒ™ãƒ†ãƒ«ã‚®ã‚¦ã‚¹)',
    originalArtist: 'Yuuri (å„ªé‡Œ)',
    tags: ['æŠ’æƒ…', 'J-POP'],
    performances: [
      { id: 'p3-1', date: '2023-11-11', streamTitle: 'é›™åä¸€å…‰æ£ç¯€é™ªä½ ', videoId: 'cbq9XW4t72E', timestamp: 2300, note: '' },
    ]
  },
  {
    id: 'song-4',
    title: 'KICK BACK',
    originalArtist: 'Kenshi Yonezu',
    tags: ['æ–æ»¾', 'å‹•æ¼«æ­Œ', 'å¸¥æ°£'],
    performances: [
      { id: 'p4-1', date: '2023-09-09', streamTitle: 'æ·±å¤œçš„æš´èµ°å¡æ‹‰OK', videoId: 'M2cckDmNLMI', timestamp: 450, note: 'å–‰åš¨æ¥µé™æŒ‘æˆ°' },
    ]
  },
   {
    id: 'song-5',
    title: 'Plastic Love',
    originalArtist: 'Mariya Takeuchi',
    tags: ['City Pop', 'ç¶“å…¸', 'å¾©å¤'],
    performances: [
      { id: 'p5-1', date: '2023-08-20', streamTitle: 'å¤æ—¥æ™šé¢¨ City Pop Night', videoId: '9Gj47G2e1Jc', timestamp: 1200, note: '' },
    ]
  },
];

// --- è¼”åŠ©å‡½å¼ ---
const formatTime = (seconds) => {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
};

// --- ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶ ---
export default function App() {
  const [searchTerm, setSearchTerm] = useState('');
  const [activeVideo, setActiveVideo] = useState(null);
  const [selectedTag, setSelectedTag] = useState(null);

  const allTags = useMemo(() => {
    const tags = new Set();
    SONG_DATABASE.forEach(song => song.tags.forEach(tag => tags.add(tag)));
    return Array.from(tags).sort();
  }, []);

  const flattenedSongs = useMemo(() => {
    let songs = [];
    SONG_DATABASE.forEach(song => {
      song.performances.forEach(perf => {
        songs.push({
          ...song,
          performanceId: perf.id,
          date: perf.date,
          streamTitle: perf.streamTitle,
          videoId: perf.videoId,
          timestamp: perf.timestamp,
          note: perf.note,
          searchString: `${song.title} ${song.originalArtist} ${perf.streamTitle}`.toLowerCase()
        });
      });
    });
    songs.sort((a, b) => new Date(b.date) - new Date(a.date));
    return songs.filter(song => {
      const lowerTerm = searchTerm.toLowerCase();
      const matchesSearch = song.searchString.includes(lowerTerm);
      const matchesTag = selectedTag ? song.tags.includes(selectedTag) : true;
      return matchesSearch && matchesTag;
    });
  }, [searchTerm, selectedTag]);

  const handlePlay = (videoId, timestamp) => setActiveVideo({ videoId, timestamp });
  const closePlayer = () => setActiveVideo(null);

  // Mizuki Light Theme Palette
  const gradientText = "bg-clip-text text-transparent bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500";
  
  return (
    // èƒŒæ™¯ï¼šæ”¹ç‚ºæ¥µæ·¡çš„ç²‰è—æ¼¸å±¤ (Mizuki é…è‰²)
    <div className="flex h-screen bg-gradient-to-br from-[#fff0f5] via-[#f0f8ff] to-[#e6e6fa] text-slate-600 font-sans selection:bg-pink-200 selection:text-pink-900 overflow-hidden">
      
      {/* =======================
          å·¦å´å°èˆªæ¬„ (Sidebar) - ç»ç’ƒæ“¬æ…‹ç™½
         ======================= */}
      <aside className="w-64 bg-white/60 backdrop-blur-xl border-r border-white/40 flex flex-col gap-2 p-3 flex-shrink-0 hidden md:flex shadow-sm z-20">
        {/* Logo å€å¡Š */}
        <div className="px-4 py-4 mb-2 flex items-center gap-2 text-slate-800">
          <div className="p-2 bg-gradient-to-tr from-pink-400 to-blue-400 rounded-lg text-white shadow-lg shadow-pink-200">
             <Mic2 className="w-6 h-6" />
          </div>
          <span className={`font-bold text-xl tracking-tight ${gradientText}`}>StreamerDB</span>
        </div>

        {/* ä¸»è¦å°èˆª */}
        <nav className="space-y-1">
          <button 
            onClick={() => {setSearchTerm(''); setSelectedTag(null);}}
            className={`w-full flex items-center gap-4 px-4 py-3 font-bold transition-all rounded-xl ${!searchTerm && !selectedTag ? 'text-white bg-gradient-to-r from-pink-400 to-blue-400 shadow-md shadow-blue-200' : 'text-slate-500 hover:text-slate-800 hover:bg-white/50'}`}
          >
            <Home className="w-5 h-5" />
            é¦–é 
          </button>
          
          <div className="relative group mt-2">
            <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <Search className="w-5 h-5 text-slate-400 group-focus-within:text-pink-400 transition-colors" />
            </div>
            <input 
               type="text"
               placeholder="æœå°‹æ­Œæ›²..."
               value={searchTerm}
               onChange={(e) => setSearchTerm(e.target.value)}
               className="w-full bg-white/50 text-slate-700 group-focus-within:bg-white border border-transparent group-focus-within:border-pink-200 group-focus-within:ring-2 group-focus-within:ring-pink-100 font-medium py-3 pl-12 pr-4 rounded-xl outline-none placeholder-slate-400 transition-all shadow-sm"
            />
          </div>
        </nav>

        {/* æ¨™ç±¤æ¸…å–® */}
        <div className="flex-1 flex flex-col min-h-0 mt-4">
          <div className="px-4 py-2 flex items-center justify-between text-slate-400">
            <span className="font-bold text-xs uppercase tracking-wider flex items-center gap-2">
              <ListMusic className="w-4 h-4" />
              é¢¨æ ¼åˆ†é¡
            </span>
          </div>
          
          <div className="mt-2 overflow-y-auto custom-scrollbar flex-1 px-1 space-y-1">
            <button
               onClick={() => setSelectedTag(null)}
               className={`w-full text-left px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${selectedTag === null ? 'text-pink-600 bg-pink-50 border border-pink-100' : 'text-slate-500 hover:text-slate-800 hover:bg-white/60'}`}
            >
              å…¨éƒ¨æ­Œæ›²
            </button>
            {allTags.map(tag => (
              <button
                key={tag}
                onClick={() => setSelectedTag(tag === selectedTag ? null : tag)}
                className={`w-full text-left px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${selectedTag === tag ? 'text-pink-600 bg-pink-50 border border-pink-100' : 'text-slate-500 hover:text-slate-800 hover:bg-white/60'}`}
              >
                #{tag}
              </button>
            ))}
          </div>
        </div>

        {/* åº•éƒ¨è£é£¾ */}
        <div className="mt-auto px-4 py-4 rounded-2xl bg-gradient-to-br from-pink-100/50 to-blue-100/50 border border-white/50">
            <p className="text-xs text-slate-500 font-medium text-center">
              Made with <Heart className="w-3 h-3 inline text-pink-400 fill-current" /> for Mizuki
            </p>
        </div>
      </aside>

      {/* =======================
          ä¸»è¦å…§å®¹å€ (Main) 
         ======================= */}
      <main className="flex-1 md:m-3 md:rounded-3xl overflow-hidden relative shadow-2xl shadow-indigo-100/50 bg-white/40 backdrop-blur-md border border-white/60 flex flex-col">
        
        {/* é ‚éƒ¨è£é£¾å…‰æšˆ */}
        <div className="absolute -top-20 -right-20 w-96 h-96 bg-pink-300/20 rounded-full blur-3xl pointer-events-none"></div>
        <div className="absolute top-40 -left-20 w-72 h-72 bg-blue-300/20 rounded-full blur-3xl pointer-events-none"></div>

        {/* æ²å‹•å€åŸŸ */}
        <div className="flex-1 overflow-y-auto custom-scrollbar relative z-10">
          
          {/* Header å…§å®¹ */}
          <header className="relative px-8 py-10 flex flex-col md:flex-row items-end gap-8 border-b border-white/40 bg-gradient-to-b from-white/60 to-transparent">
             {/* å°ˆè¼¯å°é¢ / ç›´æ’­ä¸»é ­åƒ */}
             <div className="w-40 h-40 sm:w-56 sm:h-56 rounded-2xl overflow-hidden flex-shrink-0 shadow-2xl shadow-pink-500/10 ring-4 ring-white">
                <div className="w-full h-full bg-gradient-to-br from-pink-100 to-blue-100 flex items-center justify-center">
                   <Mic2 className="w-20 h-20 text-white drop-shadow-lg" />
                   {/* å¦‚æœæœ‰çœŸå¯¦åœ–ç‰‡ï¼Œé€™è£¡æ˜¯ <img src={STREAMER_INFO.avatarUrl} ... /> */}
                </div>
             </div>

             <div className="flex flex-col gap-3 w-full mb-2">
                <span className="text-sm font-bold uppercase tracking-wider text-pink-500 flex items-center gap-1 bg-pink-50 w-fit px-2 py-1 rounded-md border border-pink-100">
                  <Sparkles className="w-3.5 h-3.5" /> 
                  Verified Artist
                </span>
                <h1 className="text-4xl md:text-7xl font-black text-slate-800 tracking-tight drop-shadow-sm">
                  {STREAMER_INFO.name}
                </h1>
                <p className="text-slate-600 text-sm md:text-base max-w-2xl font-medium leading-relaxed">
                  {STREAMER_INFO.description}
                </p>
                
                <div className="flex items-center gap-4 mt-2 text-sm text-slate-500 font-bold">
                   <span>{flattenedSongs.length} é¦–æ­Œæ›²</span>
                   <span className="w-1 h-1 bg-slate-300 rounded-full"></span>
                   <div className="flex gap-3">
                      <a href={STREAMER_INFO.socialLinks.youtube} target="_blank" rel="noopener noreferrer" className="hover:text-red-500 transition-colors bg-white p-1.5 rounded-full shadow-sm hover:shadow-md"><Youtube className="w-4 h-4"/></a>
                      <a href={STREAMER_INFO.socialLinks.twitter} target="_blank" rel="noopener noreferrer" className="hover:text-blue-400 transition-colors bg-white p-1.5 rounded-full shadow-sm hover:shadow-md"><Twitter className="w-4 h-4"/></a>
                   </div>
                </div>
             </div>
          </header>

          {/* æ“ä½œåˆ— */}
          <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md px-8 py-4 flex items-center justify-between border-b border-white/50 shadow-sm">
            <div className="flex items-center gap-4">
               {/* æ’­æ”¾æŒ‰éˆ• */}
               <button className="w-14 h-14 rounded-full bg-gradient-to-r from-pink-400 to-blue-400 text-white flex items-center justify-center shadow-lg shadow-pink-500/30 transform hover:scale-105 transition-all hover:brightness-110">
                  <Play className="w-7 h-7 fill-current ml-1" />
               </button>
               <button className="text-slate-500 hover:text-slate-800 border-2 border-slate-200 hover:border-slate-800 rounded-full px-6 py-2 text-sm font-bold transition-all uppercase tracking-wide">
                  è¿½è¹¤
               </button>
            </div>
            
            {/* æ‰‹æ©Ÿç‰ˆæœå°‹ */}
            <div className="md:hidden relative">
              <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
              <input 
                type="text" 
                placeholder="æœå°‹..." 
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="bg-white border border-slate-200 rounded-full py-2 pl-9 pr-4 text-sm text-slate-700 w-36 focus:w-52 transition-all outline-none shadow-sm"
              />
            </div>
          </div>

          {/* æ­Œæ›²åˆ—è¡¨ (Table View) */}
          <div className="px-6 pb-20 mt-4">
            <div className="grid grid-cols-[auto_1fr_1fr_auto] md:grid-cols-[auto_2fr_2fr_1fr_auto] gap-4 px-4 py-3 border-b border-slate-200/60 text-slate-400 text-xs font-bold uppercase tracking-wider sticky top-[88px] z-10">
              <div className="w-8 text-center">#</div>
              <div>æ¨™é¡Œ</div>
              <div className="hidden md:block">å‡ºè™•ç›´æ’­</div>
              <div className="hidden md:block">ç™¼å¸ƒæ—¥æœŸ</div>
              <div className="flex justify-end pr-4"><Clock className="w-4 h-4" /></div>
            </div>

            <div className="mt-2 space-y-1">
              {flattenedSongs.length === 0 ? (
                 <div className="py-20 text-center text-slate-400">
                    <p className="text-lg">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„æ­Œæ›² â˜ï¸</p>
                 </div>
              ) : (
                flattenedSongs.map((song, index) => (
                  <div 
                    key={`${song.id}-${song.performanceId}`}
                    className="group grid grid-cols-[auto_1fr_1fr_auto] md:grid-cols-[auto_2fr_2fr_1fr_auto] gap-4 px-4 py-3 rounded-xl hover:bg-white/60 items-center transition-all cursor-default border border-transparent hover:border-white/50 hover:shadow-sm"
                  >
                    {/* 1. åºè™Ÿ / æ’­æ”¾æŒ‰éˆ• */}
                    <div className="w-8 flex justify-center text-slate-400 font-mono text-sm relative">
                      <span className="group-hover:opacity-0 transition-opacity text-slate-400">{index + 1}</span>
                      <button 
                        onClick={() => handlePlay(song.videoId, song.timestamp)}
                        className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 text-pink-500 transition-all transform hover:scale-110"
                      >
                        <Play className="w-4 h-4 fill-current" />
                      </button>
                    </div>

                    {/* 2. æ¨™é¡Œèˆ‡åŸå”± */}
                    <div className="min-w-0 pr-4">
                      <div className={`font-bold truncate text-base ${activeVideo?.videoId === song.videoId && activeVideo?.timestamp === song.timestamp ? 'text-pink-500' : 'text-slate-800'}`}>
                        {song.title}
                      </div>
                      <div className="text-sm text-slate-500 truncate hover:underline hover:text-slate-800 cursor-pointer flex items-center gap-2 mt-0.5">
                        {song.originalArtist}
                        {song.note && (
                          <span className="text-[10px] border border-blue-200 text-blue-500 px-1.5 py-0.5 rounded-full bg-blue-50 font-medium">
                            {song.note}
                          </span>
                        )}
                      </div>
                    </div>

                    {/* 3. å‡ºè™•ç›´æ’­ (æ¡Œæ©Ÿé¡¯ç¤º) */}
                    <div className="hidden md:flex items-center text-sm text-slate-500 hover:text-slate-800 transition-colors min-w-0">
                      <span className="truncate">{song.streamTitle}</span>
                    </div>

                    {/* 4. æ—¥æœŸ (æ¡Œæ©Ÿé¡¯ç¤º) */}
                    <div className="hidden md:flex text-sm text-slate-500 min-w-0 font-mono">
                      {song.date}
                    </div>

                    {/* 5. æ™‚é•· / æ“ä½œ */}
                    <div className="flex items-center justify-end gap-4 text-sm text-slate-500 pr-2">
                      <a 
                        href={`https://www.youtube.com/watch?v=${song.videoId}&t=${song.timestamp}s`}
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all transform hover:scale-110 bg-white p-1.5 rounded-full shadow-sm"
                        title="åœ¨ YouTube é–‹å•Ÿ"
                      >
                         <ExternalLink className="w-4 h-4" />
                      </a>
                      <span className="font-mono min-w-[40px] text-right">{formatTime(song.timestamp)}</span>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      </main>

      {/* =======================
          æ’­æ”¾å™¨ (Light Theme Modal)
         ======================= */}
      {activeVideo && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/30 backdrop-blur-sm animate-fade-in">
          <div className="relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden ring-1 ring-black/5 flex flex-col">
            <div className="flex items-center justify-between px-5 py-4 border-b border-slate-100 bg-white">
              <div className="flex items-center gap-3">
                 <div className="relative">
                    <div className="w-2.5 h-2.5 rounded-full bg-pink-500 animate-ping absolute opacity-75"></div>
                    <div className="w-2.5 h-2.5 rounded-full bg-pink-500 relative"></div>
                 </div>
                 <span className="text-slate-800 font-bold text-sm tracking-wide">æ­£åœ¨æ’­æ”¾ â€¢ {STREAMER_INFO.name}</span>
              </div>
              <button 
                onClick={closePlayer}
                className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-800 transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            
            <div className="relative aspect-video bg-black">
              <iframe
                src={`https://www.youtube.com/embed/${activeVideo.videoId}?start=${activeVideo.timestamp}&autoplay=1`}
                title="YouTube video player"
                className="absolute inset-0 w-full h-full"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowFullScreen
              ></iframe>
            </div>
          </div>
          <div className="absolute inset-0 -z-10" onClick={closePlayer}></div>
        </div>
      )}
    </div>
  );
}
