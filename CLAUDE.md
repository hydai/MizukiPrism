# MizukiPrism

Fan-facing song catalog and player for VTuber 浠Mizuki's karaoke livestream archive. Deployed as a static site on GitHub Pages.

## Tech Stack

- **Frontend**: Next.js 16 + React 19 + TypeScript + Tailwind CSS
- **CLI Tool**: Python 3.10+ (MizukiLens at `tools/mizukilens/`)
- **Icons**: Lucide React
- **E2E Tests**: Playwright (Chromium only, `tests/*.spec.ts`)
- **Python Tests**: pytest (`tools/mizukilens/tests/`)

## Project Structure

```
app/
├── components/        React components (AlbumArt, MiniPlayer, NowPlayingModal, QueuePanel, PlaylistPanel, Toast, ...)
├── contexts/          React contexts (PlayerContext, PlaylistContext, FanAuthContext)
├── api/               Next.js API routes (songs, streams, metadata, versions, auth)
├── page.tsx           Main song catalog page (~2400 lines)
lib/
├── types.ts           Data models (Song, Performance, Stream, SongMetadata, ArtistInfo)
├── data.ts            Data loading utilities
├── utils.ts           General utilities
data/
├── songs.json         Song catalog with performances
├── streams.json       Stream/VOD metadata
├── streamer.json      Streamer profile info
├── metadata/          Album art metadata (generated by CLI)
│   ├── song-metadata.json
│   └── artist-info.json
tools/mizukilens/      Python CLI for data pipeline
├── src/mizukilens/
│   ├── cli.py         Click CLI (fetch, extract, review, export, import, metadata group, cache group)
│   ├── metadata.py    iTunes API client, metadata file I/O
│   └── ...
└── tests/
```

## Commands

### Frontend

```bash
npm run dev          # Dev server on localhost:3000
npm run build        # Production build (use to verify no errors)
npm run lint         # ESLint
npx playwright test  # E2E tests (requires dev server running)
```

### MizukiLens CLI

```bash
cd tools/mizukilens
.venv/bin/python3 -m pytest tests/ -v   # Run Python tests (840+)
.venv/bin/pip install -e .              # Install in dev mode
mizukilens metadata fetch --missing     # Fetch album art for new songs
mizukilens metadata status              # View metadata coverage
mizukilens metadata override <id>       # Manual override
mizukilens metadata clear <id>          # Clear metadata entry
```

The Python venv is at `tools/mizukilens/.venv/`. Use `.venv/bin/python3` to run tests, not the system `python3`.

## Conventions

### Git

- Conventional Commits: `feat:`, `fix:`, `docs:`, `refactor:`, `chore:`
- One concern per commit
- Run `lineguard <files>` before committing to fix format issues
- Pre-commit hooks auto-run format, lint, and test checks

### Frontend

- Components use `'use client'` directive
- CSS variables for theming: `--accent-pink`, `--bg-surface-frosted`, `--text-secondary`, `--text-tertiary`
- Tailwind classes + inline styles with CSS vars
- Gradient placeholder pattern for missing album art (see `AlbumArt.tsx`)
- Metadata loaded at page init

### Python CLI

- Click for CLI commands, Rich for progress bars and tables
- Follow existing patterns in `cli.py` when adding commands
- All API clients mock external calls in tests (no live API hits)
- `data/metadata/` files are JSON arrays, read/written atomically

## Architecture Notes

- **Static deployment**: All data is in JSON files committed to git. No runtime database. Fan-facing site is read-only.
- **Client-side merge**: Frontend fetches `songs.json` + `song-metadata.json` separately, merges in browser by songId.
- **Metadata lifecycle**: CLI fetches from iTunes → writes JSON → commit → deploy → fans see it. `manual` status entries are never auto-overwritten unless `--force`.
- **AlbumArt** component is reusable across 5 UI positions (song list, mini player desktop/mobile, now playing modal, queue panel).
